name: Processar Coment√°rios

on:
  repository_dispatch:
    types: [new-comment, new-suggestion]
  workflow_dispatch:
    inputs:
      test:
        description: 'Teste manual do workflow'
        required: false
        default: 'false'

jobs:
  process-comment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Debug - Mostrar evento recebido
      run: |
        echo "Tipo de evento: ${{ github.event.action }}"
        echo "Dados recebidos:"
        echo '${{ toJson(github.event.client_payload) }}'
        
    - name: Processar novo coment√°rio
      if: github.event.action == 'new-comment'
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_CLASSIC }}
        DISCUSSION_ID: "D_kwDONItOJ84AtXqV"
      run: |
        echo "Processando coment√°rio..."
        echo "Usu√°rio: ${{ github.event.client_payload.username }}"
        echo "Avalia√ß√£o: ${{ github.event.client_payload.rating }}/5 estrelas"
        echo "Coment√°rio: ${{ github.event.client_payload.comment }}"
        
        # Preparar corpo do coment√°rio
        COMMENT_BODY="üë§ **${{ github.event.client_payload.username }}**

        ‚≠ê **Avalia√ß√£o:** ${{ github.event.client_payload.rating }}/5 estrelas

        üí¨ **Coment√°rio:**
        ${{ github.event.client_payload.comment }}

        ---
        *Enviado via sistema de coment√°rios autom√°tico*"
        
        # Enviar para GitHub Discussions (s√≥ funciona se o token tiver permiss√µes)
        curl -X POST \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Content-Type: application/json" \
          -H "Accept: application/vnd.github.v3+json" \
          -d "{
            \"query\": \"mutation { addDiscussionComment(input: { discussionId: \\\"$DISCUSSION_ID\\\", body: \\\"$COMMENT_BODY\\\" }) { comment { id } } }\"
          }" \
          https://api.github.com/graphql || echo "Token sem permiss√£o ou erro na API - coment√°rio registrado nos logs"

    - name: Processar nova sugest√£o
      if: github.event.action == 'new-suggestion'
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN_CLASSIC }}
        DISCUSSION_ID: "D_kwDONItOJ84AtXqY"
      run: |
        echo "Processando sugest√£o..."
        echo "Usu√°rio: ${{ github.event.client_payload.username }}"
        echo "T√≠tulo: ${{ github.event.client_payload.title }}"
        echo "Sugest√£o: ${{ github.event.client_payload.suggestion }}"
        
        # Preparar corpo da sugest√£o
        SUGGESTION_BODY="üë§ **${{ github.event.client_payload.username }}**

        üìù **${{ github.event.client_payload.title }}**

        üí° **Sugest√£o:**
        ${{ github.event.client_payload.suggestion }}

        ---
        *Enviado via sistema de sugest√µes autom√°tico*"
        
        # Enviar para GitHub Discussions (s√≥ funciona se o token tiver permiss√µes)
        curl -X POST \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Content-Type: application/json" \
          -H "Accept: application/vnd.github.v3+json" \
          -d "{
            \"query\": \"mutation { addDiscussionComment(input: { discussionId: \\\"$DISCUSSION_ID\\\", body: \\\"$SUGGESTION_BODY\\\" }) { comment { id } } }\"
          }" \
          https://api.github.com/graphql || echo "Token sem permiss√£o ou erro na API - sugest√£o registrada nos logs"
          
    - name: Log de confirma√ß√£o
      run: |
        echo "‚úÖ Processamento conclu√≠do!"
        echo "Timestamp: $(date)"
        echo "Evento processado: ${{ github.event.action }}"
